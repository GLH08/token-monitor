# Token Monitor

ä¸“ä¸º [New API](https://github.com/Calcium-Ion/new-api) / [One API](https://github.com/songquanpeng/one-api) è®¾è®¡çš„ Token ç”¨é‡ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿã€‚

![Dashboard](https://img.shields.io/badge/Dashboard-React-61DAFB?style=flat-square&logo=react)
![Backend](https://img.shields.io/badge/Backend-Node.js-339933?style=flat-square&logo=node.js)
![Database](https://img.shields.io/badge/Database-SQLite-003B57?style=flat-square&logo=sqlite)
![Docker](https://img.shields.io/badge/Deploy-Docker-2496ED?style=flat-square&logo=docker)

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### ğŸ“Š æ•°æ®çœ‹æ¿
- å®æ—¶ç»Ÿè®¡ Token æ¶ˆè€—ã€è¯·æ±‚æ•°ã€æ´»è·ƒæ¨¡å‹æ•°
- æ”¯æŒ 1å°æ—¶/6å°æ—¶/12å°æ—¶/24å°æ—¶/7å¤©/30å¤© å¤šæ—¶é—´ç»´åº¦
- æ¨¡å‹æ¶ˆè€—åˆ†å¸ƒå †å å›¾ã€æ¸ é“æ¶ˆè€—å æ¯”é¥¼å›¾
- Token æ¶ˆè€—è¶‹åŠ¿æŠ˜çº¿å›¾
- WebSocket å®æ—¶æ•°æ®æ¨é€

### ğŸ–¥ï¸ æ¸ é“ç›‘æ§
- æ¸ é“çŠ¶æ€æ€»è§ˆï¼ˆæ­£å¸¸/æ‰‹åŠ¨ç¦ç”¨/è‡ªåŠ¨ç¦ç”¨ï¼‰
- æ¸ é“æ€§èƒ½è¯¦æƒ…ï¼ˆè¯·æ±‚æ•°ã€Tokenã€è´¹ç”¨ã€é”™è¯¯ç‡ã€å»¶è¿Ÿï¼‰
- è¯·æ±‚é‡ Top 10 æ’è¡Œ
- æ¸ é“çŠ¶æ€åˆ†å¸ƒé¥¼å›¾

### ğŸ¤– æ¨¡å‹åˆ†æ
- æ¨¡å‹ä½¿ç”¨ç»Ÿè®¡ï¼ˆè¯·æ±‚æ•°ã€Tokenã€è´¹ç”¨ï¼‰
- Token åˆ†å¸ƒ Top 8 é¥¼å›¾
- æ¨¡å‹é”™è¯¯ç‡å’Œå¹³å‡å»¶è¿Ÿåˆ†æ
- æ”¯æŒå¤šæ—¶é—´ç»´åº¦åˆ‡æ¢

### ğŸ”‘ Token ç®¡ç†
- Token çŠ¶æ€æ€»è§ˆï¼ˆæ­£å¸¸/ç¦ç”¨/è¿‡æœŸ/è€—å°½ï¼‰
- é¢åº¦ä½¿ç”¨æƒ…å†µï¼ˆå·²ç”¨/å‰©ä½™/æ— é™ï¼‰
- Token ä½¿ç”¨æ¬¡æ•°ç»Ÿè®¡
- ä½é¢åº¦ Token é¢„è­¦

### ğŸ“‹ æ—¥å¿—æ˜ç»†
- åˆ†é¡µæŸ¥è¯¢æ‰€æœ‰ API è¯·æ±‚æ—¥å¿—
- æ”¯æŒæŒ‰æ¸ é“ IDã€æ¨¡å‹åç§°ã€æ—¶é—´èŒƒå›´ç­›é€‰
- è‡ªå®šä¹‰æ—¶é—´é€‰æ‹©å™¨ï¼Œç²¾ç¡®åˆ°åˆ†é’Ÿ
- æŸ¥çœ‹å®Œæ•´è¯·æ±‚/å“åº” JSON å†…å®¹
- ç»Ÿè®¡ç­›é€‰ç»“æœçš„ Token æ€»é‡å’Œè´¹ç”¨

### âŒ é”™è¯¯æ—¥å¿—
- ç‹¬ç«‹çš„é”™è¯¯æ—¥å¿—æŸ¥çœ‹é¡µé¢
- æ”¯æŒæŒ‰æ¸ é“ã€æ¨¡å‹ç­›é€‰
- åˆ†é¡µæµè§ˆé”™è¯¯è¯¦æƒ…

### âš¡ æ€§èƒ½åˆ†æ
- API å¹³å‡å»¶è¿Ÿè¶‹åŠ¿å›¾
- è¯·æ±‚é‡ (RPM) å’Œ Token ååé‡ (TPM) è¶‹åŠ¿
- Top 20 æ…¢è¯·æ±‚æ’è¡Œæ¦œ
- è¶…æ—¶è¯·æ±‚ (>5s) çº¢è‰²é«˜äº®æ ‡è¯†

### ğŸš¨ å‘Šè­¦é…ç½®
- 6 ç§å‘Šè­¦ç±»å‹ï¼šToken ç”¨é‡ã€é”™è¯¯ç‡ã€å»¶è¿Ÿã€æ¸ é“å®•æœºã€é¢åº¦ä¸è¶³ã€è¯·æ±‚çªå¢
- å¤šç§ç»Ÿè®¡å‘¨æœŸï¼š1h/6h/12h/24h/48h/72h/7å¤©/30å¤©/è‡ªç„¶æ—¥/è‡ªå®šä¹‰æ—¶é—´èŒƒå›´
- å‘Šè­¦ç”Ÿæ•ˆæ—¶é—´çª—å£ï¼ˆå¦‚ä»…å·¥ä½œæ—¶é—´ç”Ÿæ•ˆï¼‰
- å‘Šè­¦å†å²è®°å½•
- 1å°æ—¶å‘Šè­¦å†·å´ï¼Œé¿å…é‡å¤é€šçŸ¥

### ğŸ“¢ Telegram é€šçŸ¥
- å‘Šè­¦è§¦å‘æ—¶é€šè¿‡ Telegram æœºå™¨äººæ¨é€é€šçŸ¥
- æ”¯æŒè‡ªå®šä¹‰ Bot Token å’Œ Chat ID

### ğŸ›¡ï¸ ç†”æ–­ä¿æŠ¤ (Circuit Breaker)
- å‘Šè­¦è§¦å‘æ—¶å¯è‡ªåŠ¨ç¦ç”¨æ¸ é“
- ç›´æ¥æ“ä½œ New API æ•°æ®åº“ï¼Œæ— éœ€ API Key
- é˜²æ­¢é…ç½®é”™è¯¯æˆ–æ¶æ„è°ƒç”¨å¯¼è‡´çš„å·¨é¢è´¦å•

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web (React)   â”‚â”€â”€â”€â”€â–¶â”‚  Server (Node)  â”‚
â”‚   Port: 5173    â”‚     â”‚   Port: 3001    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                         â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  SQLite (æœ¬åœ°) â”‚         â”‚ MySQL (è¿œç¨‹)  â”‚
           â”‚  ç»Ÿè®¡/å‘Šè­¦æ•°æ®  â”‚         â”‚ New API æ—¥å¿—  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **å‰ç«¯**: React 19 + Vite + TailwindCSS + Recharts
- **åç«¯**: Express + Prisma (MySQL) + SQLite + WebSocket
- **éƒ¨ç½²**: Docker Compose

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### æ–¹å¼ä¸€ï¼šé•œåƒéƒ¨ç½²ï¼ˆæ¨èï¼‰

åªéœ€ä¸€ä¸ªé…ç½®æ–‡ä»¶å³å¯éƒ¨ç½²ï¼Œæ— éœ€ clone ä»£ç ï¼š

```bash
# åˆ›å»ºç›®å½•
mkdir token-monitor && cd token-monitor

# ä¸‹è½½éƒ¨ç½²é…ç½®
curl -O https://raw.githubusercontent.com/GLH08/token-monitor/main/deploy/docker-compose.yml

# ç¼–è¾‘é…ç½®ï¼ˆä¿®æ”¹æ•°æ®åº“è¿æ¥å’Œå¯†ç ï¼‰
nano docker-compose.yml

# å¯åŠ¨
docker compose up -d
```

è®¿é—®ï¼š`http://æœåŠ¡å™¨IP:3000`

### æ–¹å¼äºŒï¼šæºç éƒ¨ç½²

é€‚åˆéœ€è¦è‡ªå®šä¹‰ä¿®æ”¹çš„åœºæ™¯ï¼š

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/GLH08/token-monitor.git
cd token-monitor

# ç¼–è¾‘é…ç½®ï¼ˆä¿®æ”¹æ•°æ®åº“è¿æ¥å’Œå¯†ç ï¼‰
nano docker-compose.yml

# æ„å»ºå¹¶å¯åŠ¨
docker compose up -d --build
```

è®¿é—®ï¼š
- Web ç•Œé¢: `http://æœåŠ¡å™¨IP:5173`
- API æœåŠ¡: `http://æœåŠ¡å™¨IP:3002`

## ğŸ“ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

| å˜é‡ | å¿…å¡« | è¯´æ˜ |
|------|------|------|
| `DATABASE_URL` | âœ… | New API MySQL è¿æ¥å­—ç¬¦ä¸² |
| `ACCESS_PASSWORD` | âœ… | Web ç™»å½•å¯†ç  |
| `TELEGRAM_BOT_TOKEN` | âŒ | Telegram æœºå™¨äºº Token |
| `TELEGRAM_CHAT_ID` | âŒ | Telegram èŠå¤© ID |

### DATABASE_URL

è¿æ¥åˆ° New API çš„ MySQL æ•°æ®åº“ï¼Œç”¨äºè¯»å–æ—¥å¿—æ•°æ®ã€‚

```
mysql://ç”¨æˆ·å:å¯†ç @IPåœ°å€:ç«¯å£/æ•°æ®åº“å
```

**è·å–æ–¹å¼**ï¼šæŸ¥çœ‹ New API çš„ `docker-compose.yml` æˆ–ç¯å¢ƒå˜é‡é…ç½®ã€‚

**æ³¨æ„**ï¼š
- å¦‚æœ Monitor å’Œ New API åœ¨åŒä¸€æœåŠ¡å™¨ï¼š
  - Docker Desktop: ä½¿ç”¨ `host.docker.internal`
  - Linux: ä½¿ç”¨å®¿ä¸»æœºå†…ç½‘ IPï¼ˆå¦‚ `172.17.0.1`ï¼‰
- ç¡®ä¿ MySQL å…è®¸è¿œç¨‹è¿æ¥ï¼ˆæ£€æŸ¥ `bind-address` å’Œç”¨æˆ·æƒé™ï¼‰

### Telegram é…ç½®

1. åœ¨ Telegram æœç´¢ `@BotFather`ï¼Œå‘é€ `/newbot` åˆ›å»ºæœºå™¨äºº
2. è·å– Bot Tokenï¼ˆæ ¼å¼ï¼š`123456789:ABCdefGHI...`ï¼‰
3. å‘æœºå™¨äººå‘é€æ¶ˆæ¯ï¼Œç„¶åè®¿é—® `https://api.telegram.org/bot<TOKEN>/getUpdates` è·å– Chat ID

## ğŸŒ Nginx åå‘ä»£ç†

é¡¹ç›®æä¾›äº† `nginx.conf` é…ç½®ç¤ºä¾‹ï¼Œæ”¯æŒ HTTPS å’Œ WebSocketã€‚

### é•œåƒéƒ¨ç½²ï¼ˆå•ç«¯å£ 3000ï¼‰

```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_read_timeout 86400;  # WebSocket é•¿è¿æ¥
}
```

### æºç éƒ¨ç½²ï¼ˆå‰ç«¯ 5173 + API 3002ï¼‰

```nginx
# Frontend
location / {
    proxy_pass http://127.0.0.1:5173;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
}

# Backend API
location /api/ {
    proxy_pass http://127.0.0.1:3002/api/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_read_timeout 86400;
}
```

## ğŸ“– ä½¿ç”¨æŒ‡å—

### åˆ›å»ºå‘Šè­¦è§„åˆ™

1. è¿›å…¥ã€Œå‘Šè­¦é…ç½®ã€é¡µé¢
2. ç‚¹å‡»ã€Œæ–°å»ºå‘Šè­¦ã€
3. é…ç½®è§„åˆ™ï¼š
   - **å‘Šè­¦ç±»å‹**ï¼šToken ç”¨é‡ã€é”™è¯¯ç‡ã€å»¶è¿Ÿã€æ¸ é“å®•æœºã€é¢åº¦ä¸è¶³ã€è¯·æ±‚çªå¢
   - **ç›‘æ§å¯¹è±¡**ï¼šé€‰æ‹©æ¸ é“ ID æˆ–æ¨¡å‹åç§°
   - **ç»Ÿè®¡å‘¨æœŸ**ï¼šé€‰æ‹©æ—¶é—´èŒƒå›´æˆ–è‡ªå®šä¹‰
   - **é˜ˆå€¼**ï¼šè®¾ç½®è§¦å‘æ¡ä»¶
   - **é€šçŸ¥æ¸ é“**ï¼šå‹¾é€‰éœ€è¦çš„é€šçŸ¥æ–¹å¼
   - **è§¦å‘åŠ¨ä½œ**ï¼šé€‰æ‹©ã€Œä»…é€šçŸ¥ã€æˆ–ã€Œé€šçŸ¥å¹¶ç¦ç”¨æ¸ é“ã€

### ç†”æ–­ä¿æŠ¤

å½“é€‰æ‹©ã€Œé€šçŸ¥å¹¶ç¦ç”¨æ¸ é“ã€æ—¶ï¼š
- å‘Šè­¦è§¦å‘åä¼šè‡ªåŠ¨å°†è¯¥æ¸ é“çŠ¶æ€è®¾ä¸ºç¦ç”¨
- ä»…å¯¹ã€Œæ¸ é“ã€ç±»å‹çš„å‘Šè­¦ç”Ÿæ•ˆ
- éœ€è¦æ‰‹åŠ¨åœ¨ New API åå°é‡æ–°å¯ç”¨æ¸ é“

## ğŸ”§ å¼€å‘è°ƒè¯•

### æœ¬åœ°å¼€å‘

```bash
# åç«¯
cd server
cp .env.example .env  # é…ç½®ç¯å¢ƒå˜é‡
npm install
npx prisma generate
node index.js

# å‰ç«¯
cd web
npm install
npm run dev
```

### ç›®å½•ç»“æ„

```
token-monitor/
â”œâ”€â”€ server/                 # åç«¯æœåŠ¡
â”‚   â”œâ”€â”€ index.js           # Express ä¸»å…¥å£ + WebSocket
â”‚   â”œâ”€â”€ syncer.js          # æ—¥å¿—åŒæ­¥æ¨¡å—
â”‚   â”œâ”€â”€ alerter.js         # å‘Šè­¦æ£€æŸ¥æ¨¡å— (6ç§å‘Šè­¦ç±»å‹)
â”‚   â”œâ”€â”€ db.js              # SQLite æ•°æ®åº“
â”‚   â””â”€â”€ prisma/            # Prisma ORM é…ç½®
â”œâ”€â”€ web/                    # å‰ç«¯åº”ç”¨
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ Dashboard.jsx  # æ•°æ®çœ‹æ¿
â”‚       â”œâ”€â”€ Channels.jsx   # æ¸ é“ç›‘æ§
â”‚       â”œâ”€â”€ Models.jsx     # æ¨¡å‹åˆ†æ
â”‚       â”œâ”€â”€ Tokens.jsx     # Token ç®¡ç†
â”‚       â”œâ”€â”€ Errors.jsx     # é”™è¯¯æ—¥å¿—
â”‚       â”œâ”€â”€ Alerts.jsx     # å‘Šè­¦é…ç½®
â”‚       â”œâ”€â”€ Performance.jsx # æ€§èƒ½åˆ†æ
â”‚       â””â”€â”€ components/    # é€šç”¨ç»„ä»¶
â”œâ”€â”€ deploy/                 # é•œåƒéƒ¨ç½²é…ç½®
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile             # å•é•œåƒæ„å»º (å‰åç«¯åˆå¹¶)
â”œâ”€â”€ docker-compose.yml     # æºç éƒ¨ç½²é…ç½®
â”œâ”€â”€ nginx.conf             # Nginx é…ç½®ç¤ºä¾‹
â””â”€â”€ README.md
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å®‰å…¨**ï¼šæœ¬ç³»ç»Ÿä»…è¯»å– New API çš„ `logs` è¡¨ï¼Œå†™å…¥æ“ä½œä»…é™äºæœ¬åœ° SQLite å’Œæ¸ é“çŠ¶æ€æ›´æ–°ï¼ˆç†”æ–­æ—¶ï¼‰
2. **ç«¯å£å¼€æ”¾**ï¼š
   - é•œåƒéƒ¨ç½²ï¼šå¼€æ”¾ `3000` ç«¯å£
   - æºç éƒ¨ç½²ï¼šå¼€æ”¾ `5173` å’Œ `3002` ç«¯å£
   - å»ºè®®ä½¿ç”¨ Nginx åå‘ä»£ç†
3. **å¯†ç ä¿æŠ¤**ï¼šè¯·è®¾ç½®å¼ºå¯†ç ï¼Œé¿å…ç›‘æ§æ•°æ®æ³„éœ²
4. **æ•°æ®åº“æƒé™**ï¼šå»ºè®®ä¸º Monitor åˆ›å»ºåªè¯»æ•°æ®åº“ç”¨æˆ·ï¼ˆç†”æ–­åŠŸèƒ½é™¤å¤–ï¼‰

## ğŸ“„ License

MIT License

## ğŸ™ è‡´è°¢

- [New API](https://github.com/Calcium-Ion/new-api)
- [One API](https://github.com/songquanpeng/one-api)
